name: Build WorldPosta Credential Provider

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-2022

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install ATL/MFC components
      shell: pwsh
      run: |
        $vsWhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
        $vsInstallPath = & $vsWhere -latest -property installationPath
        $vsInstaller = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vs_installer.exe"
        & $vsInstaller modify --installPath $vsInstallPath --add Microsoft.VisualStudio.Component.VC.ATL --quiet --norestart --wait

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Add msbuild to PATH
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Build Release x64
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        msbuild multiOTPCredentialProvider.sln /p:Configuration=Release /p:Platform=x64 /t:Build /m /p:PlatformToolset=v143

    - name: List build outputs
      run: |
        Write-Host "=== All DLLs ==="
        Get-ChildItem -Recurse -Filter "*.dll" | Select-Object FullName
        Write-Host "=== All LIBs ==="
        Get-ChildItem -Recurse -Filter "*.lib" | Select-Object FullName

    - name: Prepare artifacts
      run: |
        New-Item -ItemType Directory -Force -Path "artifacts"
        # Find and copy credential provider DLL
        $dll = Get-ChildItem -Recurse -Filter "multiOTPCredentialProvider.dll" | Select-Object -First 1
        if ($dll) {
          Copy-Item $dll.FullName -Destination "artifacts/"
          Write-Host "Found DLL: $($dll.FullName)"
        }
        # Also copy filter DLL if exists
        $filterDll = Get-ChildItem -Recurse -Filter "multiOTPCredentialProviderFilter.dll" | Select-Object -First 1
        if ($filterDll) {
          Copy-Item $filterDll.FullName -Destination "artifacts/"
          Write-Host "Found Filter DLL: $($filterDll.FullName)"
        }
        Get-ChildItem artifacts/

    - name: Upload DLL Artifact
      uses: actions/upload-artifact@v4
      with:
        name: WorldPostaCredentialProvider-DLL
        path: artifacts/

    - name: Upload stable files
      uses: actions/upload-artifact@v4
      with:
        name: stable-files
        path: stable/

  build-linux:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libpam0g-dev libcurl4-openssl-dev libssl-dev libjson-c-dev

    - name: Build PAM module
      working-directory: worldposta-ssh-mfa
      run: |
        make clean || true
        make

    - name: Prepare Linux artifacts
      run: |
        mkdir -p package
        cp worldposta-ssh-mfa/pam_worldposta.so package/
        cp worldposta-ssh-mfa/config/worldposta.conf package/
        cp worldposta-ssh-mfa/scripts/install.sh package/
        cp worldposta-ssh-mfa/scripts/uninstall.sh package/
        chmod +x package/*.sh
        tar -czvf WorldPosta-SSH-MFA.tar.gz -C package .

    - name: Upload Linux Artifact
      uses: actions/upload-artifact@v4
      with:
        name: WorldPosta-SSH-MFA-Linux
        path: WorldPosta-SSH-MFA.tar.gz

  create-installer:
    runs-on: windows-2022
    needs: build-windows

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download DLL
      uses: actions/download-artifact@v4
      with:
        name: WorldPostaCredentialProvider-DLL
        path: artifacts

    - name: Download stable files
      uses: actions/download-artifact@v4
      with:
        name: stable-files
        path: stable

    - name: Install WiX Toolset
      run: choco install wixtoolset -y --force

    - name: Prepare installer files
      run: |
        New-Item -ItemType Directory -Force -Path "x64/Release"
        Copy-Item artifacts/*.dll -Destination "x64/Release/"
        New-Item -ItemType Directory -Force -Path "WixInstall/obj"

    - name: List files for debugging
      run: |
        Write-Host "=== x64/Release contents ==="
        Get-ChildItem x64/Release -Recurse
        Write-Host "=== stable contents ==="
        Get-ChildItem stable -Recurse | Select-Object -First 20

    - name: Build MSI Installer
      working-directory: WixInstall
      shell: pwsh
      run: |
        $wixPath = Get-ChildItem "C:\Program Files (x86)\WiX Toolset*\bin" -ErrorAction SilentlyContinue | Select-Object -First 1
        if (-not $wixPath) {
          $wixPath = "C:\Program Files (x86)\WiX Toolset v3.14\bin"
        }
        Write-Host "Using WiX at: $wixPath"
        & "$wixPath\candle.exe" WorldPostaSetup.wxs WorldPostaUI.wxs -out obj\ -ext WixUIExtension
        & "$wixPath\light.exe" obj\WorldPostaSetup.wixobj obj\WorldPostaUI.wixobj -out WorldPostaAuthenticator.msi -ext WixUIExtension -sval

    - name: Upload Installer
      uses: actions/upload-artifact@v4
      with:
        name: WorldPostaAuthenticator-Installer
        path: WixInstall/WorldPostaAuthenticator.msi

  release:
    runs-on: ubuntu-latest
    needs: [create-installer, build-linux]
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Download Windows Installer
      uses: actions/download-artifact@v4
      with:
        name: WorldPostaAuthenticator-Installer
        path: installer

    - name: Download Linux Artifact
      uses: actions/download-artifact@v4
      with:
        name: WorldPosta-SSH-MFA-Linux
        path: linux

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: WorldPosta Authenticator v1.0.${{ github.run_number }}
        files: |
          installer/WorldPostaAuthenticator.msi
          linux/WorldPosta-SSH-MFA.tar.gz
        fail_on_unmatched_files: false
        body: |
          ## WorldPosta Authenticator v1.0.${{ github.run_number }}

          ### Windows RDP 2FA
          Download `WorldPostaAuthenticator.msi` and run the installer.

          ### Linux SSH 2FA
          ```bash
          tar -xzf WorldPosta-SSH-MFA.tar.gz
          sudo ./scripts/install.sh
          sudo nano /etc/worldposta/worldposta.conf  # Add your API keys
          sudo systemctl restart sshd
          ```
        draft: false
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
