name: Build WorldPosta Credential Provider

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install ATL/MFC components
      shell: pwsh
      run: |
        $vsWhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
        $vsInstallPath = & $vsWhere -latest -property installationPath
        $vsInstaller = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vs_installer.exe"
        & $vsInstaller modify --installPath $vsInstallPath --add Microsoft.VisualStudio.Component.VC.ATL --quiet --norestart --wait

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Add msbuild to PATH
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Build Release x64
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        msbuild multiOTPCredentialProvider.sln /p:Configuration=Release /p:Platform=x64 /t:Build /m /p:PlatformToolset=v143

    - name: List build outputs
      run: |
        Get-ChildItem -Recurse -Filter "*.dll" | Select-Object FullName
        Get-ChildItem -Recurse -Filter "*.exe" | Select-Object FullName

    - name: Upload DLL Artifact
      uses: actions/upload-artifact@v4
      with:
        name: WorldPostaCredentialProvider-DLL
        path: |
          x64/Release/*.dll

    - name: Upload stable files
      uses: actions/upload-artifact@v4
      with:
        name: stable-files
        path: stable/

  create-installer:
    runs-on: windows-2022
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download DLL
      uses: actions/download-artifact@v4
      with:
        name: WorldPostaCredentialProvider-DLL
        path: x64/Release

    - name: Download stable files
      uses: actions/download-artifact@v4
      with:
        name: stable-files
        path: stable

    - name: Install WiX Toolset
      run: choco install wixtoolset --version=3.11.2 -y

    - name: Create installer directory
      run: mkdir -p WixInstall/obj

    - name: List files for debugging
      run: |
        Write-Host "=== x64/Release contents ==="
        Get-ChildItem x64/Release -Recurse
        Write-Host "=== stable contents ==="
        Get-ChildItem stable -Recurse | Select-Object -First 20

    - name: Build MSI Installer
      working-directory: WixInstall
      shell: cmd
      run: |
        "C:\Program Files (x86)\WiX Toolset v3.11\bin\candle.exe" WorldPostaSetup.wxs WorldPostaUI.wxs -out obj\ -ext WixUIExtension
        "C:\Program Files (x86)\WiX Toolset v3.11\bin\light.exe" obj\WorldPostaSetup.wixobj obj\WorldPostaUI.wixobj -out WorldPostaAuthenticator.msi -ext WixUIExtension -sval

    - name: Upload Installer
      uses: actions/upload-artifact@v4
      with:
        name: WorldPostaAuthenticator-Installer
        path: WixInstall/WorldPostaAuthenticator.msi

  release:
    runs-on: ubuntu-latest
    needs: create-installer
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Download Installer
      uses: actions/download-artifact@v4
      with:
        name: WorldPostaAuthenticator-Installer
        path: installer

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: WorldPosta Authenticator v1.0.${{ github.run_number }}
        files: installer/WorldPostaAuthenticator.msi
        draft: false
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
